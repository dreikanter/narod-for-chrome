<!DOCTYPE html>
<html>
<head>
<style>
body
{
	overflow-x:hidden;
	font-family:Helvetica,Arial,sans-serif;
	font-size:.8em;
	line-height:1.5em;
}
td
{
	vertical-align:top;
}
table#layout
{
	width:18em;
}
td#message
{
	background-position:0 0;
	background-repeat:no-repeat;
	padding-left:28px;
}
td#button
{
	float:right;
	margin-left:.5em;
}
a#close
{
	color:gray;
	background-color:transparent;
}
</style>

<script src="jquery.js"></script>
<script>

const proxyUrl = 'http://narod.paradigm.ru/get/';

const messageTimeout = 1000;

function getProxyUrl(narodUrl)
{
	return proxyUrl + '?' + narodUrl;
}

function setIcon(iconFile)
{
	$('td#message').css('background-image', 
		(iconFile == '') ? '' : ('url(' + iconFile + ')'));
}

function show(iconType, message)
{
	switch(iconType)
	{
		case 'working': setIcon('images/working.gif'); break;
		case 'done': setIcon('images/done.png'); break;
		case 'link': setIcon('images/link.png'); break;
		case 'copy': setIcon('images/copy.png'); break;
		case 'error': setIcon('images/error.png'); break;
		default: setIcon(''); break;
	}
	$('td#message').html(message);
}

function showWithTimeout(iconType, message)
{
	show(iconType, message);
	$('a#close').html('Ok');
	setTimeout('window.close()', messageTimeout);
}

function showError(message)
{
	show('error', 'Ошибка: ' + message);
}

// Вынимает имя файла из URL на народе.ру
function extractFileName(url) {
	var result = '';
	if(url.match(/^http:\/\/narod(\.yandex)?\.ru\/disk\/[\w\d\.]+\/(.+)(\.html)?$/)) {
		result = RegExp.$1;
	} else if(url.match(/\/([^\/]+)$/)) {
		result = RegExp.$1;
	} else {
		result = url;
	}
	return result;
}

// Готовит имя файла из URL для отображения в попапе
function getFileName(url, maxLength)
{
	var fileName = extractFileName(url);
	fileName = fileName.split('%20').join(' ');
	if(fileName.length > maxLength)
	{
		fileName = jQuery.trim(fileName.substr(0, maxLength)) + '&hellip;';
	}
	return fileName.split(' ').join('&nbsp;');
}


addEventListener('load', function()
{
	chrome.tabs.getSelected(null, function(tab) {
		var currentUrl = tab.url.replace('.yandex.', '.');		
		show('working', 'Реквестируем&nbsp;файл');
		$('a#close').click(function() { window.close(); });
		
		$.ajax({
			url: getProxyUrl(currentUrl), // 'http://narod.paradigm.ru/test.zip'
			context: document.body,
			timeout: 10000,
			success: function(data)
			{
				if(data.match(/^http:\/\/.+/))
				{
					var action = localStorage['narod_action'];
					switch(action)
					{
						case "copy":
							showWithTimeout('copy', 'Ссылка скопирована');
							var textarea = document.createElement('textarea');
							textarea.value = data;
							textarea.style.position = 'absolute';
							textarea.style.top = -textarea.height;
							textarea.style.left = -textarea.width;
							document.body.appendChild(textarea); 
							textarea.select(); 
							document.execCommand('copy'); 
							document.body.removeChild(textarea); 
							break;
						case "show":
							showWithTimeout('link', 'Ссылка получена');
							chrome.tabs.update(tab.id, { url: getProxyUrl(currentUrl) });
							break;
						default:
							showWithTimeout('done', 'Скачиваем!');
							chrome.tabs.update(tab.id, { url: data });
							break;
					}
				}
				else
				{
					var errMessage = '';
					switch(data)
					{
						// Первые две ошибки не случаются никогда (при текущем варианте
						// background.html). Ветки добавлены только для полноты картины.
						case 'error:100':
							errMessage = 'некорректный URL.'; // URL not specified.
							break;
						case 'error:101':
							errMessage = 'некорректный URL.'; // Wrong URL specified.
							break;
						case 'error:102':
							errMessage = 'файл не найден. Вероятно он был удален с сервиса.'; // Required file not found. Probably it was deleted by user or service.
							break;
						default:
							errMessage = 'этого не может быть, Профессор!';
							break;
					}
					showError(errMessage);
				}
			},
	      	error: function(request, textStatus, errorThrown)
	      	{
	      		var errorMsg = (textStatus == 'timeout') ? 
	      			'таймаут.' : textStatus;
				showError(errorMsg);
	      	}
      	});
	});
});

</script>
</head>
<body>
	<table id="layout"><tr>
		<td width="100%" id="message">!!1</td>
		<td id="button"><a href="#" id="close">Отмена</a></td>
	</tr></table>
</body>
</html>